# 0002 — Auth (email + password) + session basics

## Goal
Implement email+password authentication for the trip planner API and basic session handling so the web app can log in and call authenticated endpoints.

## Decisions (for this ticket)
- Start with cookie-based sessions OR bearer JWT (choose one and document choice briefly in `docs/adr/0001-auth-sessions.md`).
- Password hashing: argon2id preferred (fallback bcrypt with strong work factor).

## Constraints
- Never log raw passwords or password hashes.
- Validate request payloads using Zod schemas in `packages/shared`.
- Auth endpoints must be rate-limited (simple in-memory is fine for dev; keep interface replaceable).
- Do not build “forgot password” yet.
- Do not add OAuth yet.

## API endpoints
Implement:
- `POST /auth/register`
  - body: `{ email, password, name? }`
  - creates user
  - returns session + user
- `POST /auth/login`
  - body: `{ email, password }`
  - returns session + user
- `POST /auth/logout`
  - clears session
- `GET /auth/me`
  - returns current user if logged in

## Data model
Add minimal Prisma models (or stub if Prisma not merged yet—ideally Prisma is ready before this ticket):
- `User`:
  - id
  - email (unique)
  - passwordHash
  - name (optional)
  - createdAt, updatedAt

## Acceptance criteria
- Requests are validated with Zod using shared schemas:
  - `packages/shared/src/schemas/auth.ts`
- Passwords are hashed securely
- Session established on login/register and cleared on logout
- `GET /auth/me` returns the authenticated user, 401 otherwise
- Add tests for:
  - register success
  - login success
  - login failure (wrong password)
  - me requires auth

## Verification
From repo root:
- `pnpm --filter api prisma migrate dev` (if Prisma used)
- `pnpm test`
- Manual smoke:
  - register → login → me → logout → me returns 401

## Notes
Keep error shapes consistent and predictable. Prefer `{ error: { code, message } }` for failures.
